<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Security &amp; Users - API Component Bundle</title><link rel="shortcut icon" href="http://localhost:4000/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css"> <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Security &amp; Users | API Component Bundle</title><meta name="generator" content="Jekyll v3.8.5" /><meta property="og:title" content="Security &amp; Users" /><meta property="og:locale" content="en_US" /><meta name="description" content="Documentation for Silverback’s API Component Bundle package" /><meta property="og:description" content="Documentation for Silverback’s API Component Bundle package" /><link rel="canonical" href="http://localhost:4000/security-and-users/" /><meta property="og:url" content="http://localhost:4000/security-and-users/" /><meta property="og:site_name" content="API Component Bundle" /> <script type="application/ld+json"> {"headline":"Security &amp; Users","url":"http://localhost:4000/security-and-users/","description":"Documentation for Silverback’s API Component Bundle package","@type":"WebPage","@context":"https://schema.org"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"><title>Link</title><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg><div class="page-wrap"><div class="side-bar"><div class="site-header"> <a href="http://localhost:4000" class="site-title lh-tight"> API Component Bundle </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button></div><div class="navigation main-nav js-main-nav"><nav role="navigation" aria-label="Main navigation"><ul class="navigation-list"><li class="navigation-list-item"><a href="http://localhost:4000/" class="navigation-list-link">Home</a><li class="navigation-list-item"><a href="http://localhost:4000/installation/" class="navigation-list-link">Installation</a><li class="navigation-list-item active"><a href="http://localhost:4000/security-and-users/" class="navigation-list-link active">Security &amp; Users</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="http://localhost:4000/security-and-users/login/" class="navigation-list-link">User Login</a><li class="navigation-list-item "><a href="http://localhost:4000/security-and-users/register/" class="navigation-list-link">Register</a><li class="navigation-list-item "><a href="http://localhost:4000/security-and-users/email-address-verification/" class="navigation-list-link">Email Address Verification</a><li class="navigation-list-item "><a href="http://localhost:4000/security-and-users/password-reset/" class="navigation-list-link">Password Reset</a><li class="navigation-list-item "><a href="http://localhost:4000/security-and-users/notification-emails/" class="navigation-list-link">Notification Emails</a></ul><li class="navigation-list-item"><a href="http://localhost:4000/resources/" class="navigation-list-link">Resources</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="http://localhost:4000/resources/core/" class="navigation-list-link">Core resources</a><li class="navigation-list-item "><a href="http://localhost:4000/resources/components/" class="navigation-list-link">Components</a></ul><li class="navigation-list-item"><a href="http://localhost:4000/configuration-reference/configuration-reference/" class="navigation-list-link">Configuration Reference</a></ul></nav></div><footer class="site-footer"><p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p></footer></div><div class="main-content-wrap js-main-content" tabindex="0"><div class="main-content"><div class="page-header js-page-header"><div class="search"><div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search API Component Bundle" aria-label="Search API Component Bundle" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg></div><div class="js-search-results search-results-wrap"></div></div><ul class="list-style-none text-small aux-nav"><li class="d-inline-block my-0"><a href="https://github.com/silverbackis/ApiComponentBundle">View on GitHub</a></ul></div><div class="page"><div id="main-content" class="page-content" role="main"><h1 id="security--users"> <a href="#security--users" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Security &amp; Users</h1><h2 id="types-of-authentication"> <a href="#types-of-authentication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Types of authentication</h2><h3 id="jwt-tokens-for-users"> <a href="#jwt-tokens-for-users" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> JWT Tokens for Users</h3><p>This bundle uses <a href="https://github.com/lexik/LexikJWTAuthenticationBundle">LexikJWTAuthenticationBundle</a> and <a href="https://github.com/markitosgv/JWTRefreshTokenBundle">JWTRefreshTokenBundle</a> to provide an authentication method for users.</p><blockquote><p>Because refresh tokens have the potential for a long lifetime, developers should ensure that strict storage requirements are in place to keep them from being leaked. For example, on web applications, refresh tokens should only leave the backend when being sent to the authorization server, and the backend should be secure. The client secret should be protected in a similar fashion. Mobile applications do not require a client secret, but they should still be sure to store refresh tokens somewhere only the client application can access.</p></blockquote><p><em>(Source: https://auth0.com/learn/refresh-tokens/)</em></p><h3 id="api-tokens-for-applications"> <a href="#api-tokens-for-applications" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> API Tokens for Applications</h3><p>We also use a simple API Token Authenticator <code class="language-plaintext highlighter-rouge">Silverback\ApiComponentBundle\Security\TokenAuthenticator</code> so that endpoints which expose sensitive data can be secured. Primarily this is so that JWT Refresh tokens are not passed directly to users.</p><h2 id="getting-started"> <a href="#getting-started" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Getting started</h2><h3 id="configure-security-and-firewalls"> <a href="#configure-security-and-firewalls" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Configure security and firewalls</h3><p>As described <a href="https://github.com/lexik/LexikJWTAuthenticationBundle/blob/master/Resources/doc/index.md#getting-started">here</a> - generate the keys for JWTs. (You fill find the passphrase that has been generated in your environment variables by the flex recipe for LexikJWTAuthenticationBundle)</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> config/jwt
openssl genpkey <span class="nt">-out</span> config/jwt/private.pem <span class="nt">-aes256</span> <span class="nt">-algorithm</span> rsa <span class="nt">-pkeyopt</span> rsa_keygen_bits:4096
openssl pkey <span class="nt">-in</span> config/jwt/private.pem <span class="nt">-out</span> config/jwt/public.pem <span class="nt">-pubout</span>
</code></pre></div></div><p>Configure <code class="language-plaintext highlighter-rouge">JWTRefreshTokenBundle</code>:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /config/packages/gesdinet_jwt_refresh_token.yaml</span>
<span class="na">gesdinet_jwt_refresh_token</span><span class="pi">:</span>
    <span class="c1"># 30 day</span>
    <span class="na">ttl</span><span class="pi">:</span> <span class="m">2592000</span>
    <span class="na">user_identity_field</span><span class="pi">:</span> <span class="s">username</span>
    <span class="na">firewall</span><span class="pi">:</span> <span class="s">main</span>
    <span class="na">user_provider</span><span class="pi">:</span> <span class="s1">'</span><span class="s">security.user.provider.concrete.user_provider'</span>
</code></pre></div></div><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /config/routes/gesdinet_jwt_refresh_token.yaml</span>
<span class="na">gesdinet_jwt_refresh_token</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span>     <span class="s">/token/refresh</span>
    <span class="na">defaults</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">_controller</span><span class="pi">:</span> <span class="nv">gesdinet.jwtrefreshtoken</span><span class="pi">:</span><span class="nv">refresh</span> <span class="pi">}</span>
</code></pre></div></div><p>The above configurations are a bit different to those that will be added by Symfony Flex for the package. The <code class="language-plaintext highlighter-rouge">user_provider</code> must use the database for us to retain the user’s roles. For our purposes, the route does not need the <code class="language-plaintext highlighter-rouge">/api</code> prefix.</p><p>Configure your security/firewall:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /config/packages/security.yaml</span>
<span class="na">security</span><span class="pi">:</span>
    <span class="na">role_hierarchy</span><span class="pi">:</span>
        <span class="na">ROLE_ADMIN</span><span class="pi">:</span>       <span class="s">ROLE_USER</span>
        <span class="na">ROLE_SUPER_ADMIN</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">ROLE_ADMIN</span><span class="pi">,</span> <span class="nv">ROLE_ALLOWED_TO_SWITCH</span><span class="pi">]</span>
    <span class="na">encoders</span><span class="pi">:</span>
        <span class="s">Silverback\ApiComponentBundle\Entity\User\AbstractUser</span><span class="pi">:</span>
            <span class="na">algorithm</span><span class="pi">:</span> <span class="s">auto</span>
    <span class="na">providers</span><span class="pi">:</span>
        <span class="na">user_provider</span><span class="pi">:</span>
            <span class="na">entity</span><span class="pi">:</span>
                <span class="na">class</span><span class="pi">:</span> <span class="s">Silverback\ApiComponentBundle\Entity\User\AbstractUser</span>
        <span class="na">jwt</span><span class="pi">:</span>
            <span class="na">lexik_jwt</span><span class="pi">:</span>
                <span class="na">class</span><span class="pi">:</span> <span class="s">Silverback\ApiComponentBundle\Entity\User\AbstractUser</span>
    <span class="na">firewalls</span><span class="pi">:</span>
        <span class="na">dev</span><span class="pi">:</span>
            <span class="na">pattern</span><span class="pi">:</span> <span class="s">^/(_(profiler|wdt)|css|images|js)/</span>
            <span class="na">security</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">refresh</span><span class="pi">:</span>
            <span class="na">pattern</span><span class="pi">:</span> <span class="s">^/token/refresh</span>
            <span class="na">stateless</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">anonymous</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">login</span><span class="pi">:</span>
            <span class="na">pattern</span><span class="pi">:</span>  <span class="s">^/login</span>
            <span class="na">stateless</span><span class="pi">:</span> <span class="no">true</span>
            <span class="c1"># anonymous: true</span>
            <span class="na">provider</span><span class="pi">:</span> <span class="s">user_provider</span>
            <span class="na">user_checker</span><span class="pi">:</span> <span class="s">Silverback\ApiComponentBundle\Security\UserChecker</span>
            <span class="na">guard</span><span class="pi">:</span>
                <span class="na">authenticators</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s">Silverback\ApiComponentBundle\Security\TokenAuthenticator</span>
            <span class="na">json_login</span><span class="pi">:</span>
                <span class="na">check_path</span><span class="pi">:</span> <span class="s">/login</span>
                <span class="na">success_handler</span><span class="pi">:</span> <span class="s">lexik_jwt_authentication.handler.authentication_success</span>
                <span class="na">failure_handler</span><span class="pi">:</span> <span class="s">lexik_jwt_authentication.handler.authentication_failure</span>
        <span class="na">main</span><span class="pi">:</span>
            <span class="na">pattern</span><span class="pi">:</span>   <span class="s">^/</span>
            <span class="na">stateless</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">anonymous</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">provider</span><span class="pi">:</span> <span class="s">jwt</span>
            <span class="na">guard</span><span class="pi">:</span>
                <span class="na">authenticators</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s">lexik_jwt_authentication.jwt_token_authenticator</span>
            <span class="c1"># https://symfony.com/doc/current/security/impersonating_user.html</span>
            <span class="na">switch_user</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">access_control</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="pi">{</span> <span class="nv">path</span><span class="pi">:</span> <span class="nv">^/login</span><span class="pi">,</span> <span class="nv">roles</span><span class="pi">:</span> <span class="nv">ROLE_TOKEN_USER</span> <span class="pi">}</span>
        <span class="pi">-</span> <span class="pi">{</span> <span class="nv">path</span><span class="pi">:</span> <span class="nv">^/token/refresh</span><span class="pi">,</span> <span class="nv">roles</span><span class="pi">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span> <span class="pi">}</span>
        <span class="pi">-</span> <span class="pi">{</span> <span class="nv">path</span><span class="pi">:</span> <span class="nv">^/password/reset</span><span class="pi">,</span> <span class="nv">roles</span><span class="pi">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="pi">,</span> <span class="nv">methods</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">POST</span><span class="pi">]</span> <span class="pi">}</span>
        <span class="pi">-</span> <span class="pi">{</span> <span class="nv">path</span><span class="pi">:</span> <span class="nv">^/component/forms/(.*)/submit</span><span class="pi">,</span> <span class="nv">roles</span><span class="pi">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="pi">,</span> <span class="nv">methods</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">POST</span><span class="pi">,</span> <span class="nv">PATCH</span><span class="pi">]</span> <span class="pi">}</span>
        <span class="pi">-</span> <span class="pi">{</span> <span class="nv">path</span><span class="pi">:</span> <span class="nv">^/</span><span class="pi">,</span> <span class="nv">roles</span><span class="pi">:</span> <span class="nv">IS_AUTHENTICATED_FULLY</span><span class="pi">,</span> <span class="nv">methods</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">POST</span><span class="pi">,</span> <span class="nv">PUT</span><span class="pi">,</span> <span class="nv">PATCH</span><span class="pi">,</span> <span class="nv">DELETE</span><span class="pi">]</span> <span class="pi">}</span>
</code></pre></div></div><h3 id="token-authentication"> <a href="#token-authentication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Token Authentication</h3><p>As part of the Symfony Flex recipe, an environment variable <code class="language-plaintext highlighter-rouge">API_SECRET_TOKEN</code> will be generated and by default used in the bundle configuration:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">silverback_api_component</span><span class="pi">:</span>
    <span class="na">security</span><span class="pi">:</span>
        <span class="na">tokens</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s1">'</span><span class="s">%env(API_SECRET_TOKEN)%'</span>
</code></pre></div></div><h3 id="jwt-authentication"> <a href="#jwt-authentication" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> JWT Authentication</h3><p>By using the flex recipe, you will already have a pre-configured <code class="language-plaintext highlighter-rouge">App\Entity\User</code> entity in your project.</p><p>By default, although there is a column for the username and one for the email address in the database, these are kept synchronised by the <code class="language-plaintext highlighter-rouge">User</code> class. You can modify the class to suit your needs. Just be sure to extend the class <code class="language-plaintext highlighter-rouge">Silverback\ApiComponentBundle\Entity\User\AbstractUser</code>.</p><p>The repository automatically configured for your User entity will look up users by their email address or username properties.</p><p>If you do not use Flex, or you create a difference User class you must configure this in the bundle:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">silverback_api_component</span><span class="pi">:</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">class_name</span><span class="pi">:</span> <span class="s">App\Entity\User</span>
</code></pre></div></div><hr><h2 class="text-delta">Table of contents</h2><ul><li> <a href="http://localhost:4000/security-and-users/login/">User Login</a><li> <a href="http://localhost:4000/security-and-users/register/">Register</a><li> <a href="http://localhost:4000/security-and-users/email-address-verification/">Email Address Verification</a><li> <a href="http://localhost:4000/security-and-users/password-reset/">Password Reset</a><li> <a href="http://localhost:4000/security-and-users/notification-emails/">Notification Emails</a></ul><hr><footer role="contentinfo"><p class="text-small text-grey-dk-000 mb-0">Copyright &copy; 2018-2020 Silverback IS. Distributed by an <a href="https://github.com/silverbackis/ApiComponentBundle/blob/master/LICENSE.txt">MIT license.</a></p></footer></div></div></div></div>
